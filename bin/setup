#!/bin/bash

set -euo pipefail

# Ask for the administrator password upfront
sudo -v

# Keep-alive: update existing `sudo` time stamp until `setup` has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &


# ==============================================================================
# HOME
# ==============================================================================

echo "------------------------------"
echo "Adding home folders"

home_folders=(
  ".ctags.d"
  ".npm-packages"
  ".ssh/sockets"
  ".ssl"
  ".zsh/cache"
  "bin"
  "labs"
  "repos"
)
for home_folder in "${home_folders[@]}"; do
  mkdir -p "${HOME}/$home_folder"
done


# ==============================================================================
# MACOS
# ==============================================================================

echo "------------------------------"
echo "Updating macOS. If this requires a restart, run the script again."

sudo softwareupdate -iaR --verbose


# ==============================================================================
# XCODE COMMAND LINE TOOLS
# ==============================================================================

if test ! "$(xcode-select -v)"; then
  echo "------------------------------"
  echo "Installing Xcode Command Line Tools"

  xcode-select --install
fi


# ==============================================================================
# HOMEBREW
# ==============================================================================

if test ! "$(brew -v)"; then
  echo "------------------------------"
  echo "Installing Homebrew"

  ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

  brew update
  brew upgrade
  brew cleanup
fi


# ==============================================================================
# VIM-PLUG
# ==============================================================================

PLUGPATH="${HOME}/.local/share/nvim/site/autoload/plug.vim"
if [[ ! -r "$PLUGPATH" ]]; then
  echo "------------------------------"
  echo "Installing vim-plug"
  curl -fLo "$PLUGPATH" --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

  echo "------------------------------"
  echo "Installing Vim plugins"
  nvim +PlugInstall +qall
fi


# ==============================================================================
# RESTART
# ==============================================================================

sudo shutdown -r now

