#!/bin/bash

set -euo pipefail

default='true'
composer=''
homebrew=''
mas=''
npm=''
os=''
ruby=''
tmux=''
vim=''

function HELP {
  echo "Usage:"
  echo -e "upgrade [options]"\\n
  echo "Options:"
  echo "-a  --Upgrade all"
  echo "-b  --Upgrade Homebrew packages"
  echo "-c  --Upgrade Composer packages"
  echo "-m  --Upgrade Mac App Store apps"
  echo "-n  --Upgrade npm packages"
  echo "-o  --Upgrade macOS"
  echo "-r  --Upgrade Ruby gems"
  echo "-t  --Upgrade Tmux plugins"
  echo "-v  --Upgrade Vim plugins"
  echo
  echo -e "Default: upgrade -b -c -m -n -r -t -v"
  exit 1
}

while getopts 'bnrcvmoaht' flag; do
  case "${flag}" in
    b) homebrew='true' default='' ;;
    c) composer='true' default='' ;;
    m) mas='true' default='' ;;
    n) npm='true' default='' ;;
    o) os='true' default='' ;;
    r) ruby='true' default='' ;;
    t) tmux='true' default='' ;;
    v) vim='true' default='' ;;
    a) homebrew='true'
       mas='true'
       npm='true'
       os='true'
       ruby='true'
       vim='true'
       tmux='true' ;;
    h) HELP
       exit 1 ;;
    *) HELP
       exit 1 ;;
  esac
done

# ==============================================================================
# HOMEBREW
# ==============================================================================

if [ $homebrew ] || [ $default ]; then
  echo
  echo "Upgrading Homebrew packages"
  echo
  brew -v update
  brew upgrade --force-bottle
  brew cu --all
  brew -v cleanup
  brew -v doctor
fi

# ==============================================================================
# NPM
# ==============================================================================

if [ $npm ] || [ $default ]; then
  echo
  echo "Upgrading npm packages"
  echo
  npx npm-check -gu
fi

# ==============================================================================
# RUBY
# ==============================================================================

if [ $ruby ] || [ $default ]; then
  echo
  echo "Upgrading Ruby gems"
  echo
  gem update --system
  gem update --no-document
fi

# ==============================================================================
# COMPOSER
# ==============================================================================

if [ $composer ] || [ $default ]; then
  echo
  echo "Upgrading Composer packages"
  echo
  composer global update
fi

# ==============================================================================
# VIM
# ==============================================================================

if [ $vim ] || [ $default ]; then
  echo
  echo "Upgrading Vim plugins"
  nvim +PlugUpgrade +PlugInstall +PlugUpdate +PlugClean +qall
fi

# ==============================================================================
# TMUX
# ==============================================================================

if [ $tmux ] || [ $default ]; then
  if ! { [ "$TERM" = "screen" ] && [ -n "$TMUX" ]; } then
    echo
    echo "Upgrading Tmux plugins"
    echo
    ~/.tmux/plugins/tpm/bin/update_plugins all
    ~/.tmux/plugins/tpm/bin/clean_plugins
  fi
fi

# ==============================================================================
# MAC APP STORE
# ==============================================================================

if [ $mas ] || [ $default ]; then
  echo
  echo "Upgrading Mac App Store apps"
  echo
  mas upgrade
fi

# ==============================================================================
# MACOS
# ==============================================================================

if [ $os ]; then
  echo
  echo "Upgrading macOS"
  echo
  sudo softwareupdate -iaR --verbose
fi

